# フロントエンド設計書

## 1. 概要
本プロジェクトのフロントエンドは、React、TypeScript、およびMaterial UI (MUI) を使用して構築された会計管理システムのWebアプリケーションです。領収書、請求書、CL決済、収納明細の管理機能を備えています。

## 2. 技術スタック
- **フレームワーク**: React 18
- **言語**: TypeScript
- **UIライブラリ**: Material UI (MUI) v5
- **データグリッド**: MUI X DataGrid
- **ルーティング**: react-router-dom v6
- **HTTPクライアント**: Axios
- **ビルドツール**: Vite
- **アイコン**: @mui/icons-material
- **画像圧縮**: browser-image-compression
- **画像ズーム**: react-zoom-pan-pinch

## 3. ディレクトリ構造
```
frontend/src/
├── components/     # 共通コンポーネント
│   ├── CameraCapture.tsx    # カメラ撮影コンポーネント
│   ├── PDFExport.tsx        # PDF出力コンポーネント
│   ├── PrivateRoute.tsx     # 認証ルートガード
│   └── ReceiptUpload.tsx    # レシートアップロード・プレビュー
├── contexts/       # React Context (認証等)
│   └── AuthContext.tsx
├── pages/          # ページコンポーネント
│   ├── Dashboard.tsx           # ダッシュボード
│   ├── Login.tsx               # ログイン画面
│   ├── MainTable.tsx           # テーブル表示の切り替え制御
│   ├── TransactionTable.tsx    # 領収書テーブル
│   ├── InvoiceTable.tsx        # 請求書テーブル
│   ├── ClPaymentTable.tsx      # CL決済テーブル
│   ├── PaymentDetailsTable.tsx # 収納明細テーブル
│   ├── ReceiptDirectory.tsx    # 領収書ディレクトリ
│   ├── InvoiceDirectory.tsx    # 請求書ディレクトリ
│   ├── ClPaymentDirectory.tsx  # CL決済ディレクトリ
│   └── PaymentDirectory.tsx    # 収納明細ディレクトリ
├── services/       # 外部API通信 (Axios)
│   └── api.ts
├── types/          # TypeScript型定義
│   └── index.ts
├── utils/          # ユーティリティ関数
│   └── receiptDetection.ts
├── App.tsx         # ルーティング・テーマ設定
└── main.tsx        # エントリーポイント
```

## 4. 画面一覧・ルーティング
全てのプライベートルートは `PrivateRoute` コンポーネントによって保護されており、認証済みユーザーのみがアクセス可能です。

| パス | 画面名 | コンポーネント | 概要 |
| :--- | :--- | :--- | :--- |
| `/login` | ログイン | `Login` | ユーザーIDとパスワードによる認証 |
| `/dashboard` | ダッシュボード | `Dashboard` | システムの統計や概要の表示 |
| `/transactions` | 領収書一覧 | `MainTable` (View: `receipts`) | 領収書データの表示・追加・編集 |
| `/invoices` | 請求書一覧 | `MainTable` (View: `invoices`) | 請求書データの表示・追加・編集 |
| `/cl-payments` | CL決済一覧 | `MainTable` (View: `cl_payments`) | CL決済データの表示・追加・編集 |
| `/payment-details` | 収納明細一覧 | `MainTable` (View: `payment_details`) | 収納明細データの表示 (管理者のみ) |
| `/receipts` | 領収書ディレクトリ | `ReceiptDirectory` | 保存された領収書ファイルのブラウズ |
| `/invoice-directory` | 請求書ディレクトリ | `InvoiceDirectory` | 保存された請求書ファイルのブラウズ |
| `/cl-payment-directory`| CL決済ディレクトリ | `ClPaymentDirectory` | 保存されたCL決済ファイルのブラウズ |
| `/payment-directory` | 収納明細ディレクトリ | `PaymentDirectory` | 保存された収納明細ファイルのブラウズ |

## 5. 主要機能

### 5.1 認証機能 (`AuthContext.tsx`)
- `AuthProvider` を通じて、ログイン状態、ユーザー情報、ログイン/ログアウト関数をアプリケーション全体に提供します。
- 認証トークンは `localStorage` に保存され、Axiosのインターセプター (`api.ts`) によって全てのリクエストヘッダーに自動的に付与されます。
- 401エラー発生時、自動的にトークンを削除しログイン画面へリダイレクトします。
- `VITE_USE_MOCK_AUTH` 環境変数により、開発用のモック認証モードをサポートしています。

### 5.2 データ管理 (Tableコンポーネント)
`MainTable.tsx` が中心となり、以下のサブコンポーネントを切り替えて表示します。
- `TransactionTable.tsx`: 領収書データのCRUD操作、検索、フィルタリング。
- `InvoiceTable.tsx`: 請求書データの管理。
- `PaymentDetailsTable.tsx`: 収納明細データの管理。
- `ClPaymentTable.tsx`: CL決済データの管理。

### 5.3 レシートアップロード (`ReceiptUpload.tsx`)
レシートのアップロード・表示・削除を行う共通コンポーネントです。

**主な機能:**
- カメラ撮影またはファイル選択によるアップロード
- アップロード前のブラウザ側画像圧縮（`browser-image-compression`）
- OCRデータの確認・修正ダイアログ
- GCS署名付きURLによる画像/PDFプレビュー（ズーム機能付き）
- レシート削除（確認ダイアログ付き）

**アイコン表示ロジック:**
- `has_receipt`が`true`の場合: 目のアイコン（プレビュー）と削除アイコンを表示
- `has_receipt`が`false`の場合: カメラアイコン（アップロード）のみ表示

**遅延読込パターン:**
一覧APIでは`receipt_url`は`null`で返されます。ユーザーがプレビューを開いた時に、`fetchReceiptUrl`（`GET /transactions/:id`）で署名付きURLを個別取得します。

### 5.4 OCR機能とカメラ撮影 (`CameraCapture.tsx`)
- モバイル端末等のカメラを使用して領収書を撮影し、サーバー側のOCRエンジンを利用して日付や金額を自動抽出します。
- 抽出されたデータは、登録前にユーザーが確認・修正できるダイアログが表示されます。

### 5.5 ファイルディレクトリ (`*Directory.tsx`)
- サーバーにアップロードされた領収書や請求書などのファイルを、年月日別にツリー構造で閲覧・ダウンロードできます。
- GCS署名付きURLで画像/PDFを直接表示します。

### 5.6 エクスポート機能
- 一覧データのCSV出力機能。
- `PDFExport.tsx` によるPDF形式での帳票出力機能。

## 6. データモデル (`types/index.ts`)

### User
```typescript
interface User {
  id: number;
  email: string;
  name: string;
  role: 'superadmin' | 'admin' | 'user';
  user_id?: string;
}
```

### Transaction
```typescript
interface Transaction {
  id?: number;
  date: string;
  deposit_from_star?: number;
  payment?: number;
  category: string;
  description: string;
  receipt_status?: string;
  payee?: string;
  balance?: number;
  user_id?: number;
  user_name?: string;
  receipt_url?: string | null;   // 一覧では常にnull（遅延読込）
  has_receipt?: boolean;          // レシート添付の有無
  is_pdf?: boolean;
  updated_at?: string;
  created_at?: string;
}
```

### PaymentDetail
```typescript
interface PaymentDetail {
  id?: number;
  deposit_date: string;
  sales_amount?: number;
  commission_fee?: number;
  consumption_tax?: number;
  transfer_amount?: number;
  user_id?: number;
  user_name?: string;
  payment_file_url?: string | null;
  is_pdf?: boolean;
  updated_at?: string;
  created_at?: string;
}
```

### ClPayment
```typescript
interface ClPayment {
  id?: number;
  payment_date: string;
  payment_amount?: number;
  vendor?: string;
  description?: string;
  user_id?: number;
  user_name?: string;
  payment_file_url?: string | null;
  is_pdf?: boolean;
  updated_at?: string;
  created_at?: string;
}
```

## 7. API通信 (`services/api.ts`)
Axiosインスタンスが共通設定されており、`VITE_API_URL` をベースURLとして使用します。
- リクエスト時に `Authorization: Bearer <token>` ヘッダーを自動付与
- 401エラー（認証切れ）発生時にトークン削除＋ログイン画面へリダイレクト

## 8. パフォーマンス最適化

### 署名付きURL遅延読込
GCS署名付きURLの生成はコストが高いため、一覧画面（`GET /transactions`）ではURLを返さず、`has_receipt`フラグのみで添付有無を表示します。ユーザーがプレビューを開いた時に`GET /transactions/:id`で個別にURLを取得します。

### ブラウザ側画像圧縮
アップロード前に`browser-image-compression`で画像を圧縮し、転送量を削減します。
- 最大サイズ: 0.7MB
- 最大解像度: 2400x2400px
- 品質: 85%

## 9. デザイン・UI
- Material UI のテーマ (`createTheme`) を使用して、一貫したカラーパレットとタイポグラフィを適用。
- モバイル対応（レスポンシブデザイン）を考慮し、`useMediaQuery` や MUI の Grid システムを活用。
- ボタン等の操作に対してアニメーション（スケール変化）を付与し、操作感（フィードバック）を向上。
